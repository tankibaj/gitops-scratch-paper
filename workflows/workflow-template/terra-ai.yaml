# SUMMARY:
#
# This workflow demonstrates a Terraform plan and apply process using Argo Workflows.
#
# DESCRIPTION:
#
# The workflow has four stages:
#
# * Cloning the Git repository containing Terraform configuration
# * Running 'terraform plan' to create an execution plan
# * A manual approval step
# * Running 'terraform apply' to apply the changes
#
# USAGE:
#
# Requires setting up secrets for accessing the Terraform backend and any other sensitive information.
#
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: terra-ai
spec:
  # must complete in 8h (28,800 seconds)
  activeDeadlineSeconds: 28800
  ttlStrategy:
    # keep workflows for 1d (86,400 seconds)
    secondsAfterCompletion: 28800 # Time to live after the workflow is completed, replaces ttlSecondsAfterFinished
  #    secondsAfterSuccess: 20 # Time to live after workflow is successful
  #    secondsAfterFailure: 120 # Time to live after workflow fails
  entrypoint: main
  volumeClaimTemplates:
    - metadata:
        name: terraform-workspace
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
  templates:
    - name: main
      dag:
        tasks:
          - name: terraform
            template: terraform
            arguments:
              parameters:
                - name: git_repo_url
                  value: "{{workflow.parameters.git_repo_url}}"
                - name: terraform_config_dir
                  value: "{{workflow.parameters.terraform_config_dir}}"
                - name: instance_name
                  value: "{{workflow.parameters.instance_name}}"
                - name: instance_type
                  value: "{{workflow.parameters.instance_type}}"

    # -- Terraform execution --
    - name: terraform
      inputs:
        parameters:
          - name: git_repo_url
          - name: git_branch_name
          - name: terraform_config_dir
      container:
        volumeMounts:
          - mountPath: /workspace
            name: terraform-workspace
        image: thenaim/terraform-git:latest
        workingDir: /workspace
        command: [sh, -c]
        env:
          - name: TF_VAR_aws_access_key
            valueFrom:
              secretKeyRef:
                name: aws-credentials
                key: aws_access_key
          - name: TF_VAR_aws_secret_key
            valueFrom:
              secretKeyRef:
                name: aws-credentials
                key: aws_secret_key
        args:
          - |
            git clone '{{inputs.parameters.git_repo_url}}' .
            terraform -chdir="{{inputs.parameters.terraform_config_dir}}" init -upgrade -no-color
            terraform -chdir="{{inputs.parameters.terraform_config_dir}}" plan -input=false -no-color -out=tfplan
            terraform -chdir="{{inputs.parameters.terraform_config_dir}}" apply -no-color -auto-approve "tfplan"
            terraform -chdir="{{inputs.parameters.terraform_config_dir}}" output